<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 ì´ë¯¸ì§€ ë””ì½”ë”© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        input[type="text"] {
            width: 300px;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .image-result {
            max-width: 100%;
            margin-top: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Base64 ì´ë¯¸ì§€ ë””ì½”ë”© ë° API í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container">
        <div class="test-section">
            <h3>1. API ì§ì ‘ í…ŒìŠ¤íŠ¸</h3>
            <p>ë°±ì—”ë“œ APIë¥¼ ì§ì ‘ í˜¸ì¶œí•´ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.</p>
            <input type="text" id="apiPrompt" placeholder="ì´ë¯¸ì§€ ì„¤ëª… (ì˜ˆ: a cute cat)" value="a cute cat">
            <button onclick="testAPI()">API í…ŒìŠ¤íŠ¸</button>
            <div id="apiResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Base64 ë°ì´í„° ì§ì ‘ í…ŒìŠ¤íŠ¸</h3>
            <p>Base64 ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•´ì„œ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>
            <textarea id="base64Input" placeholder="Base64 ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." style="width: 100%; height: 100px; margin-bottom: 10px;"></textarea>
            <br>
            <button onclick="testBase64()">Base64 ë³€í™˜ í…ŒìŠ¤íŠ¸</button>
            <div id="base64Result" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Fabric.js í†µí•© í…ŒìŠ¤íŠ¸</h3>
            <p>ì‹¤ì œ Fabric.js ìº”ë²„ìŠ¤ì— ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.</p>
            <button onclick="testFabricIntegration()">Fabric.js í…ŒìŠ¤íŠ¸</button>
            <div id="fabricResult" class="result" style="display: none;"></div>
            <canvas id="fabricCanvas" width="600" height="400" style="border: 1px solid #ddd; margin-top: 10px; display: none;"></canvas>
        </div>
    </div>

    <script type="module">
        import { Canvas, Image as FabricImage } from 'https://cdn.skypack.dev/fabric@5.3.0';
        
        let fabricCanvas = null;
        let lastApiResponse = null;

        // API í…ŒìŠ¤íŠ¸
        window.testAPI = async function() {
            const prompt = document.getElementById('apiPrompt').value;
            const resultDiv = document.getElementById('apiResult');
            
            if (!prompt.trim()) {
                alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading">ğŸ”„ API í˜¸ì¶œ ì¤‘...</div>';

            try {
                console.log('ğŸš€ API í…ŒìŠ¤íŠ¸ ì‹œì‘:', prompt);
                
                const response = await fetch('http://localhost:8000/api/images/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                console.log('ğŸ“Š ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                lastApiResponse = data;
                
                console.log('âœ… API ì‘ë‹µ ë°ì´í„°:', data);

                let debugInfo = `ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.ok ? 'OK' : 'ERROR'}
ì‘ë‹µ í‚¤ë“¤: ${Object.keys(data).join(', ')}
ì„±ê³µ ì—¬ë¶€: ${data.success}
íŒŒì¼ëª…: ${data.filename || 'N/A'}
íŒŒì¼ í¬ê¸°: ${data.file_size || 'N/A'} bytes
ë©”ì‹œì§€: ${data.message || 'N/A'}
image_data ì¡´ì¬: ${!!data.image_data}
image_data ê¸¸ì´: ${data.image_data?.length || 0}
image_data ì• 100ì: ${data.image_data?.substring(0, 100) || 'N/A'}`;

                if (data.success && data.image_data) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>âœ… API í˜¸ì¶œ ì„±ê³µ!</h4>
                        <div class="debug-info">${debugInfo}</div>
                        <p><strong>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</strong></p>
                        <img src="data:image/png;base64,${data.image_data}" 
                             alt="ìƒì„±ëœ ì´ë¯¸ì§€" 
                             class="image-result"
                             onload="console.log('âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ')"
                             onerror="console.error('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨')">
                        <br><br>
                        <button onclick="document.getElementById('base64Input').value = lastApiResponse.image_data; testBase64();">
                            ì´ ë°ì´í„°ë¡œ Base64 í…ŒìŠ¤íŠ¸í•˜ê¸°
                        </button>
                    `;
                } else {
                    throw new Error(data.message || 'ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                console.error('âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>âŒ API í˜¸ì¶œ ì‹¤íŒ¨</h4>
                    <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                    <p><strong>í•´ê²° ë°©ë²•:</strong></p>
                    <ul>
                        <li>ë°±ì—”ë“œ ì„œë²„ê°€ http://localhost:8000 ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸</li>
                        <li>CORS ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸</li>
                        <li>ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì˜ Network íƒ­ í™•ì¸</li>
                    </ul>
                `;
            }
        };

        // Base64 ì§ì ‘ í…ŒìŠ¤íŠ¸
        window.testBase64 = function() {
            const base64Data = document.getElementById('base64Input').value;
            const resultDiv = document.getElementById('base64Result');
            
            if (!base64Data.trim()) {
                alert('Base64 ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            resultDiv.style.display = 'block';

            try {
                console.log('ğŸ” Base64 í…ŒìŠ¤íŠ¸ ì‹œì‘');
                console.log('ğŸ“ ë°ì´í„° ê¸¸ì´:', base64Data.length);
                
                // Base64 ìœ íš¨ì„± ê²€ì‚¬
                const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
                if (!base64Regex.test(base64Data)) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ Base64 í˜•ì‹ì…ë‹ˆë‹¤.');
                }
                
                if (base64Data.length % 4 !== 0) {
                    throw new Error('Base64 ê¸¸ì´ê°€ 4ì˜ ë°°ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤.');
                }
                
                // MIME íƒ€ì… ê°ì§€
                const mimeType = base64Data.startsWith('iVBOR') ? 'image/png' : 
                               base64Data.startsWith('/9j/') ? 'image/jpeg' : 'image/png';
                
                console.log('ğŸ¨ ê°ì§€ëœ MIME íƒ€ì…:', mimeType);
                
                const debugInfo = `Base64 ê¸¸ì´: ${base64Data.length}
4ì˜ ë°°ìˆ˜ ì—¬ë¶€: ${base64Data.length % 4 === 0}
ê°ì§€ëœ íƒ€ì…: ${mimeType}
ì²« 20ì: ${base64Data.substring(0, 20)}
ë§ˆì§€ë§‰ 20ì: ${base64Data.substring(base64Data.length - 20)}`;

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>âœ… Base64 ë³€í™˜ ì„±ê³µ!</h4>
                    <div class="debug-info">${debugInfo}</div>
                    <p><strong>ë³€í™˜ëœ ì´ë¯¸ì§€:</strong></p>
                    <img src="data:${mimeType};base64,${base64Data}" 
                         alt="Base64 ì´ë¯¸ì§€" 
                         class="image-result"
                         onload="console.log('âœ… Base64 ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ')"
                         onerror="console.error('âŒ Base64 ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨')">
                `;

            } catch (error) {
                console.error('âŒ Base64 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>âŒ Base64 ë³€í™˜ ì‹¤íŒ¨</h4>
                    <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                `;
            }
        };

        // Fabric.js í†µí•© í…ŒìŠ¤íŠ¸
        window.testFabricIntegration = async function() {
            const resultDiv = document.getElementById('fabricResult');
            const canvasElement = document.getElementById('fabricCanvas');
            
            if (!lastApiResponse || !lastApiResponse.image_data) {
                alert('ë¨¼ì € API í…ŒìŠ¤íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            resultDiv.style.display = 'block';
            canvasElement.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<div class="loading">ğŸ”„ Fabric.js í…ŒìŠ¤íŠ¸ ì¤‘...</div>';

            try {
                console.log('ğŸ¨ Fabric.js í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                // Fabric ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
                if (!fabricCanvas) {
                    fabricCanvas = new Canvas(canvasElement);
                    fabricCanvas.setDimensions({ width: 600, height: 400 });
                    fabricCanvas.backgroundColor = '#ffffff';
                }
                
                fabricCanvas.clear();
                fabricCanvas.renderAll();
                
                const imageData = lastApiResponse.image_data;
                console.log('ğŸ“¦ ì´ë¯¸ì§€ ë°ì´í„° ì²˜ë¦¬ ì¤‘...');
                
                // ì´ë¯¸ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸
                const img = new Image();
                
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', {
                            width: img.width,
                            height: img.height,
                            naturalWidth: img.naturalWidth,
                            naturalHeight: img.naturalHeight
                        });
                        resolve();
                    };
                    
                    img.onerror = (error) => {
                        console.error('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                        reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    img.src = `data:image/png;base64,${imageData}`;
                });
                
                // Fabric ì´ë¯¸ì§€ ìƒì„±
                console.log('ğŸ”§ Fabric ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                const fabricImg = await FabricImage.fromElement(img);
                
                if (!fabricImg) {
                    throw new Error('Fabric ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨');
                }
                
                // ìº”ë²„ìŠ¤ì— ë§ê²Œ í¬ê¸° ì¡°ì •
                const scale = Math.min(
                    fabricCanvas.getWidth() / img.naturalWidth,
                    fabricCanvas.getHeight() / img.naturalHeight
                ) * 0.8;
                
                fabricImg.scale(scale);
                fabricCanvas.add(fabricImg);
                fabricCanvas.centerObject(fabricImg);
                fabricCanvas.renderAll();
                
                console.log('âœ… Fabric.js í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <h4>âœ… Fabric.js í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ!</h4>
                    <p>ì´ë¯¸ì§€ê°€ ì•„ë˜ ìº”ë²„ìŠ¤ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p><strong>ì´ë¯¸ì§€ ì •ë³´:</strong> ${img.naturalWidth}x${img.naturalHeight}px</p>
                    <p><strong>ìŠ¤ì¼€ì¼:</strong> ${scale.toFixed(3)}</p>
                `;

            } catch (error) {
                console.error('âŒ Fabric.js í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>âŒ Fabric.js í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</h4>
                    <p><strong>ì—ëŸ¬:</strong> ${error.message}</p>
                `;
            }
        };
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        window.lastApiResponse = null;
        window.fabricCanvas = null;
    </script>
</body>
</html>
